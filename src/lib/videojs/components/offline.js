import videojs from"video.js";const defaults={offlineStream:"",offlineImage:"",offlineTimeout:30,liveSource:"",onretry:!1,offlineCountdown:!1,liveStream:"",clock:0},registerPlugin=videojs.registerPlugin||videojs.plugin,onPlayerReady=(e,n)=>{var i,o=videojs.dom,t=e.el();e.offline.liveSource=function(e){n.liveStream=e};if(n.offlineCountdown){var s=document.createElement("div");s.className="offlineCounter";s.style.position="absolute";s.style.right="30px";s.style.bottom="25px";s.style.fontSize="20px";s.style.color="#fff";s.style.textShadow="1px 1px 1px #000"}function r(){return!!a(t,".offlineCounter")}var a=function(e,n){try{return e.querySelector(n)}catch(e){return!1}};function l(){var n=e.play();void 0!==n&&n.then(function(){}).catch(function(n){e.muted(!0);e.play()})}e.tech(!0).on("retryplaylist",function(){if(n.onretry){e.isOffline=!0;v()}});function f(){var n=a(t,".vjs-error-display");n&&o.addClass(n,"vjs-hidden");o.addClass(a(t,".vjs-control-bar"),"vjs-hidden");o.addClass(a(t,".vjs-background-bar"),"vjs-hidden");var i=a(t,".vjs-chromecast-button");i&&o.addClass(i,"vjs-abs-hidden");e.$(".vjs-tech").style.pointerEvents="none"}function d(){e.poster(n.offlineImage);a(t,".vjs-poster").style.opacity="1";var i=a(t,".vjs-error-display");o.addClass(a(t,".vjs-big-play-button"),"vjs-hidden");o.addClass(a(t,".vjs-loading-spinner"),"vjs-hidden");o.addClass(a(t,".vjs-control-bar"),"vjs-hidden");o.addClass(a(t,".vjs-background-bar"),"vjs-hidden");i&&o.addClass(i,"vjs-abs-hidden");var s=a(t,".vjs-chromecast-button");s&&o.addClass(s,"vjs-abs-hidden")}function c(n){var i=new XMLHttpRequest;void 0!==n.withCredentials&&(i.withCredentials=!0);i.onload=function(){if(200===this.status){e.src(n);e.load();e.play();e.isOffline=!1;return!0}e.isOffline=!0;f();e.play()};i.onerror=function(){e.isOffline=!0;f();e.play()};void 0!==n.src?i.open("HEAD",n.src):i.open("HEAD",n);i.send()}function v(){""===n.liveStream&&(n.liveStream=e.currentSource());if(""!==n.offlineStream){e.src({src:n.offlineStream,offline:!0});f();e.isOffline=!0;o.hasClass(t,"vjs-has-started")?l():e.pause();if(n.offlineCountdown){1!=r()&&t.appendChild(s);s.innerHTML=u(e.duration())}e.on("timeupdate",function(){if(e.isOffline&&n.offlineCountdown&&e.currentTime()>0){1!=r()&&t.appendChild(s);var i=u(e.duration()-e.currentTime());s.innerHTML=i}});e.on("ended",function(){if(e.isOffline){o.addClass(a(t,".vjs-big-play-button"),"vjs-hidden");c(n.liveStream)}});return!0}if(""!==n.offlineImage){d();if(n.offlineCountdown){1!=r()&&t.appendChild(s);s.innerHTML=u(n.offlineTimeout)}n.clock=0;v();e.src(n.offlineImage);e.load();function v(){clearTimeout(i);i=setTimeout(function(){n.clock++;var e=u(n.offlineTimeout-n.clock);if(n.offlineCountdown){1!=r()&&t.appendChild(s);e=u(n.offlineTimeout-n.clock);s.innerHTML=e.toString()}if(n.clock>=n.offlineTimeout){n.clock=-1;c(n.liveStream)}v()},1e3)}}}function u(e){var n=parseInt(e,10);return[Math.floor(n/3600),Math.floor(n/60)%60,n%60].map(e=>e<10?"0"+e:e).filter((e,n)=>"00"!==e||n>0).join(":")}e.on("error",function(){if(!e.isOffline){var n=e.error();if(2==n.code||4==n.code||-2==n.code){e.isOffline=!0;v()}}});e.on("playing",function(){var n=a(t,".vjs-chromecast-button");if(e.isOffline)n&&o.addClass(n,"vjs-abs-hidden");else{clearTimeout(i);e.$(".vjs-tech").style.pointerEvents="auto";o.removeClass(a(t,".vjs-big-play-button"),"vjs-hidden");o.removeClass(a(t,".vjs-loading-spinner"),"vjs-hidden");o.removeClass(a(t,".vjs-control-bar"),"vjs-hidden");o.removeClass(a(t,".vjs-background-bar"),"vjs-hidden");n&&o.removeClass(n,"vjs-abs-hidden");try{t.removeChild(s)}catch(e){}a(t,".vjs-poster").style.opacity="0"}})},offline=function(e){this.ready(()=>{onPlayerReady(this,videojs.mergeOptions(defaults,e))})};registerPlugin("offline",offline);offline.VERSION="1.1";export default offline;