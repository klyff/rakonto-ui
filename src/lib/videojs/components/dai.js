import videojs from"video.js";const defaults={fallback:"",assetKey:"",source_id:"",video_id:"",liveApiKey:"",apiKey:"",debug:!1},registerPlugin=videojs.registerPlugin||videojs.plugin,onPlayerReady=(e,a)=>{var i,t=e.$(".vjs-tech"),d=!1,o=(e.el(),new Array),r=!1;videojs.options.autoplay&&(r=!0);t.getAttribute("autoplay")&&(r=!0);n();""!=a.assetKey?function(){d=!0;var e=new google.ima.dai.api.LiveStreamRequest;e.assetKey=a.assetKey;e.apiKey=a.liveApiKey||"";i.requestStream(e)}():""!=a.source_id&&""!=a.video_id&&function(){d=!1;var e=new google.ima.dai.api.VODStreamRequest;e.contentSourceId=a.source_id;e.videoId=a.video_id;e.apiKey=a.apiKey||"";i.requestStream(e)}();e.dai.requestVODStream=function(a){d=!1;i.reset();e.reset();videojs.dom.removeClass(e.el_,"vjs-dai");videojs.dom.removeClass(e.el_,"vjs-has-started");videojs.dom.removeClass(e.el_,"vjs-playing");videojs.dom.removeClass(e.bigPlayButton.el_,"vjs-no-pointer");n();var t=new google.ima.dai.api.VODStreamRequest;t.contentSourceId=a.source_id;t.videoId=a.video_id;t.apiKey=a.apiKey||"";i.requestStream(t)};e.dai.requestLivetream=function(a){d=!0;i.reset();e.reset();videojs.dom.removeClass(e.el_,"vjs-dai");videojs.dom.removeClass(e.el_,"vjs-has-started");videojs.dom.removeClass(e.el_,"vjs-playing");videojs.dom.removeClass(e.bigPlayButton.el_,"vjs-no-pointer");var t=new google.ima.dai.api.LiveStreamRequest;t.assetKey=a.assetKey;t.apiKey=a.apiKey||"";i.requestStream(t)};function n(){(i=i=new google.ima.dai.api.StreamManager(t)).addEventListener(google.ima.dai.api.StreamEvent.Type.LOADED,m,!1);i.addEventListener(google.ima.dai.api.StreamEvent.Type.ERROR,p,!1);i.addEventListener(google.ima.dai.api.StreamEvent.Type.AD_PROGRESS,y,!1);i.addEventListener(google.ima.dai.api.StreamEvent.Type.AD_BREAK_STARTED,c,!1);i.addEventListener(google.ima.dai.api.StreamEvent.Type.AD_BREAK_ENDED,E,!1);i.addEventListener(google.ima.dai.api.StreamEvent.Type.STARTED,f,!1);i.addEventListener(google.ima.dai.api.StreamEvent.Type.FIRST_QUARTILE,s,!1);i.addEventListener(google.ima.dai.api.StreamEvent.Type.MIDPOINT,l,!1);i.addEventListener(google.ima.dai.api.StreamEvent.Type.THIRD_QUARTILE,v,!1);i.addEventListener(google.ima.dai.api.StreamEvent.Type.COMPLETE,g,!1);i.addEventListener(google.ima.dai.api.StreamEvent.Type.CLICK,u,!1)}function s(a){e.trigger("dai",{ad:o,type:"firstQuartile"})}function l(a){e.trigger("dai",{ad:o,type:"midpoint"})}function v(a){e.trigger("dai",{ad:o,type:"thirdQuartile"})}function g(a){e.trigger("dai",{ad:o,type:"complete"})}function u(a){e.trigger("dai",{ad:o,type:"adClick"})}function m(t){e.textTracks().addEventListener("addtrack",function(e){var t=e.track;"metadata"===t.kind&&t.addEventListener("cuechange",function(e){a.debug&&console.log(t.activeCues[0]);var d=t.activeCues[0];if(d&&d.value.data){var o={};o[d.value.key]=d.value.data;o.duration=1/0;i.onTimedMetadata(o)}},!1)},!1);e.src(t.getStreamData().url);r&&e.play()}function p(i){""!=a.fallback&&e.src(a.fallback)}function y(a){if(1!=d){var i=a.getStreamData().adProgressData,t=i.adPosition,o=i.totalAds,r=i.currentTime,n=i.duration,s=Math.floor(n-r),l=e.controlBar.el_.querySelector(".vjs-vast-label");l.innerHTML=1==o?"This Ad will end in "+s+"s":"Ad ("+t+" of "+o+") "+s+"s"}}function c(e){S(!0)}function E(e){o="undefined";S(!1)}function f(a){var i=a.getAd();(o=new Array).id=i.getAdId();o.title=i.getTitle();o.duration=i.getDuration();o.url=i.g.g.u;e.trigger("dai",{ad:o,type:"started"})}function S(a){var i=e.controlBar.el_.querySelector(".vjs-vast-label");if(a){videojs.dom.addClass(e.el_,"vjs-dai");d&&(i.innerHTML="Ad Playing")}else{videojs.dom.removeClass(e.el_,"vjs-dai");e.adPlaying=!1}}},dai=function(e){this.ready(()=>{onPlayerReady(this,videojs.mergeOptions(defaults,e))})};registerPlugin("dai",dai);export default dai;